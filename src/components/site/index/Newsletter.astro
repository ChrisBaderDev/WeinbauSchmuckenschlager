---
import HorizontalLine from "../../animation/HorizontalLine.astro";
---

<HorizontalLine direction="left" color="black" width="100%" />
<section class="p-10">
  <h2>Newsletter</h2>
  <p>Sollen wir dich auf dem Laufenden halten?</p>
  <form id="newsletter-form">
    <label class="flex flex-col text-sm py-5">
      E-Mail-Adresse *
      <input
        class="border rounded-0 p-2"
        type="email"
        name="email"
        required
        placeholder="E-Mail-Adresse eingeben"
      />
    </label>
    <button
      class="bg-black text-white mt-5 hover:bg-gray-800 py-3 transition-colors hover:cursor-pointer w-full"
      type="submit">Anmelden</button
    >
  </form>
  <div id="newsletter-success-message" class="hidden text-center py-12">
    <h3 class="text-2xl mb-4">Vielen Dank!</h3>
    <p class="text-gray-600">
      Wir haben deine Anmeldung erhalten und melden uns mit einer Bestätigungsmail.
    </p>
  </div>
  <div id="newsletter-failure-message" class="hidden text-center py-12">
    <h3 class="text-2xl mb-4">Es gab ein Problem mit der Absendung!</h3>
    <p class="text-gray-600">
      Leider konnten wir Sie nicht für den Newsletter anmelden. Bitte versuchen
      Sie es erneut.
    </p>
  </div>
</section>

<script>
  import Botpoison from "@botpoison/browser";

  const botpoison = new Botpoison({
    publicKey: "pk_6670cf52-9797-4e87-a3ef-742d372089ab",
  });

  const form = document.getElementById("newsletter-form") as HTMLFormElement;
  const successMessage = document.getElementById("newsletter-success-message");
  const failureMessage = document.getElementById("newsletter-failure-message");

  form?.addEventListener("submit", async (e) => {
    e.preventDefault();
    failureMessage?.classList.add("hidden");
    const submitBtn = form.querySelector(
      "button[type='submit']",
    ) as HTMLButtonElement;
    submitBtn.disabled = true;
    submitBtn.textContent = "Wird gesendet...";
    const formData = new FormData(form);
    const data = Object.fromEntries(formData);

    try {
      const { solution } = await botpoison.challenge();

      const response = await fetch("https://submit-form.com/t7uGU7v38", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Accept: "application/json",
        },
        body: JSON.stringify({
          ...data,
          "_email.subject": "Neue Newsletteranmeldung",
          "_email.from": "Website - Weinbau Schmuckenschlager",
          _botpoison: solution,
        }),
      });

      if (response.ok) {
        form.classList.add("hidden");
        successMessage?.classList.remove("hidden");
      } else {
        failureMessage?.classList.remove("hidden");
      }
    } catch (error) {
      failureMessage?.classList.remove("hidden");
    } finally {
      submitBtn.disabled = false;
      submitBtn.textContent = "Anmelden";
    }
  });
</script>

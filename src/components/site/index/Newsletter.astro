---
import HorizontalLine from "../../animation/HorizontalLine.astro";
---

<HorizontalLine direction="left" color="black" width="100%" />
<section class="flex flex-col px-5 py-10 md:flex-row md:p-10 gap-10 items-center md:h-[50vh]">
  <div class="flex flex-col justify-center y w-full md:w-6/10">
    <h2>Newsletter</h2>
    <p>Sollen wir dich auf dem Laufenden halten?</p>
    <form id="newsletter-form">
      <label class="flex flex-col text-sm py-5 mb-5">
        E-Mail-Adresse *
        <input
          class="border rounded-0 p-2"
          type="email"
          name="email"
          required
          placeholder="E-Mail-Adresse eingeben"
        />
      </label>
      <button
        class="bg-black text-white hover:bg-neutral-800 py-3 transition-colors hover:cursor-pointer w-full"
        type="submit">Anmelden</button
      >
    </form>

    <div id="newsletter-success-message" class="hidden text-center py-12">
      <h3 class="text-2xl mb-4">Vielen Dank!</h3>
      <p class="text-gray-600">
        Wir haben deine Anmeldung erhalten und melden uns mit einer
        Bestätigungsmail.
      </p>
    </div>
    <div id="newsletter-failure-message" class="hidden text-center py-12">
      <h3 class="text-2xl mb-4">Es gab ein Problem mit der Absendung!</h3>
      <p class="text-gray-600">
        Leider konnten wir Sie nicht für den Newsletter anmelden. Bitte
        versuchen Sie es erneut.
      </p>
    </div>
  </div>
  <div class="flex justify-center items-center w-full md:w-1/10">
    <p class="text-neutral-800">oder</p>
  </div>
  <div class="flex flex-col justify-start items-center md:justify-center flex-1 md:w-3/10">
    <h2 class="mb-5 max-md:hidden">WhatsApp</h2>
    <img class="p-10 w-75 max-md:hidden" src="/whatsapp_qr_code.png">
    <a
      href="https://chat.whatsapp.com/EGcTwOEjfAGK1Ts018O19i"
      target="_blank"
      rel="noopener noreferrer"
      class="flex items-center justify-center gap-3 w-full py-3 px-5 text-center border border-black text-black hover:bg-black hover:text-white transition-colors"
    >
      WhatsApp-Gruppe beitreten
    </a>
  </div>
</section>

<script>
  import Botpoison from "@botpoison/browser";

  const botpoison = new Botpoison({
    publicKey: "pk_6670cf52-9797-4e87-a3ef-742d372089ab",
  });

  const form = document.getElementById("newsletter-form") as HTMLFormElement;
  const successMessage = document.getElementById("newsletter-success-message");
  const failureMessage = document.getElementById("newsletter-failure-message");

  form?.addEventListener("submit", async (e) => {
    e.preventDefault();
    failureMessage?.classList.add("hidden");
    const submitBtn = form.querySelector(
      "button[type='submit']",
    ) as HTMLButtonElement;
    submitBtn.disabled = true;
    submitBtn.textContent = "Wird gesendet...";
    const formData = new FormData(form);
    const data = Object.fromEntries(formData);

    try {
      const { solution } = await botpoison.challenge();

      const response = await fetch("https://submit-form.com/t7uGU7v38", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Accept: "application/json",
        },
        body: JSON.stringify({
          ...data,
          "_email.subject": "Neue Newsletteranmeldung",
          "_email.from": "Website - Weinbau Schmuckenschlager",
          _botpoison: solution,
        }),
      });

      if (response.ok) {
        form.classList.add("hidden");
        successMessage?.classList.remove("hidden");
      } else {
        failureMessage?.classList.remove("hidden");
      }
    } catch (error) {
      failureMessage?.classList.remove("hidden");
    } finally {
      submitBtn.disabled = false;
      submitBtn.textContent = "Anmelden";
    }
  });
</script>
